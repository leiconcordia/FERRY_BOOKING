CREATE TABLE Users (
    UserID INT IDENTITY(1,1) PRIMARY KEY,
    FirstName VARCHAR(100) NOT NULL,
    LastName VARCHAR(100) NOT NULL,
    CompanyName VARCHAR(200) NOT NULL,
    Email VARCHAR(200) NOT NULL UNIQUE,
    PasswordHash VARBINARY(MAX) NOT NULL,
    Role VARCHAR(20) NOT NULL DEFAULT 'FerryOwner',
    DateCreated DATETIME NOT NULL DEFAULT GETDATE(),
    IsActive BIT NOT NULL DEFAULT 1
);

CREATE TABLE Ferry (
    FerryID INT IDENTITY(1,1) PRIMARY KEY,
    FerryCode VARCHAR(50) NOT NULL UNIQUE,
    OwnerID INT NOT NULL,
    FerryName VARCHAR(100) NOT NULL,
    TotalFloors INT NOT NULL,
    TotalCapacity INT NOT NULL DEFAULT 0,
    Status VARCHAR(20) NOT NULL DEFAULT 'Inactive',
    DateRegistered DATETIME DEFAULT GETDATE()
);

CREATE TABLE FerryFloor (
    FloorID INT IDENTITY(1,1) PRIMARY KEY,
    FerryID INT NOT NULL,
    FloorNumber INT NOT NULL,
    Rows INT NOT NULL,
    Columns INT NOT NULL,
    Capacity AS (Rows * Columns) PERSISTED,
    FOREIGN KEY (FerryID) REFERENCES Ferry(FerryID)
);

CREATE TABLE Route (
    RouteID INT IDENTITY(1,1) PRIMARY KEY,
    Origin VARCHAR(100) NOT NULL,
    Destination VARCHAR(100) NOT NULL,
    Distance DECIMAL(10,2) NULL,      -- in kilometers (e.g. 70.50)
    Duration TIME NULL,               -- estimated travel duration (e.g. 02:30:00)
    FerryID INT;
    FOREIGN KEY (FerryID) REFERENCES Ferry(FerryID);
    CONSTRAINT UQ_Route UNIQUE(Origin, Destination)
);

ALTER TABLE Route
ADD FerryID INT;

ALTER TABLE Route
ADD CONSTRAINT FK_Route_Ferry FOREIGN KEY (FerryID)
REFERENCES Ferry(FerryID);


CREATE TABLE Trip (
    TripID INT IDENTITY(1,1) PRIMARY KEY,
    FerryID INT NOT NULL,
    RouteID INT NOT NULL,
    DepartureTime TIME NOT NULL,
    ArrivalTime TIME NOT NULL,
    StartDate DATE NOT NULL,
    EndDate DATE NOT NULL,
    DaysOfWeek VARCHAR(50) NOT NULL,  -- e.g., 'Mon,Wed,Fri'

    FOREIGN KEY (FerryID) REFERENCES Ferry(FerryID),
    FOREIGN KEY (RouteID) REFERENCES Route(RouteID)
);


CREATE TABLE FerryDocuments (
    DocumentID INT IDENTITY(1,1) PRIMARY KEY,
    FerryID INT NOT NULL FOREIGN KEY REFERENCES Ferry(FerryID),
    COFile VARBINARY(MAX) NULL,
    VRFile VARBINARY(MAX) NULL,
    SCFile VARBINARY(MAX) NULL,
    IDFile VARBINARY(MAX) NULL,
    POFile VARBINARY(MAX) NULL,
    FPFile VARBINARY(MAX) NULL
);

CREATE TABLE BookedSeats
(
    BookedSeatID INT IDENTITY(1,1) PRIMARY KEY,
    TripID INT NOT NULL,
    FloorID INT NOT NULL,
    FerryID INT NOT NULL,
    SeatNumber VARCHAR(10) NULL,   -- optional, if you track exact seat
    BookingDate DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (TripID) REFERENCES Trip(TripID),
    FOREIGN KEY (FerryID) REFERENCES Ferry(FerryID)
);

CREATE TABLE FerryRoute (
    FerryRouteID INT IDENTITY(1,1) PRIMARY KEY,
    FerryID INT NOT NULL,
    RouteID INT NOT NULL,
    FOREIGN KEY (FerryID) REFERENCES Ferry(FerryID),
    FOREIGN KEY (RouteID) REFERENCES Route(RouteID),
    CONSTRAINT UQ_FerryRoute UNIQUE(FerryID, RouteID)
);

CREATE TABLE TripFloorPrice (
    TripFloorPriceID INT IDENTITY(1,1) PRIMARY KEY,
    TripID INT NOT NULL,
    FerryID INT NOT NULL,
    FloorNumber INT NOT NULL,
    Price DECIMAL(10,2) NOT NULL,

    FOREIGN KEY (TripID) REFERENCES Trip(TripID),
    FOREIGN KEY (FerryID, FloorNumber) REFERENCES FerryFloor(FerryID, FloorNumber)
);
CREATE TABLE Schedule (
    ScheduleID INT IDENTITY(1,1) PRIMARY KEY,
    FerryID INT NOT NULL,
    RouteID INT NOT NULL,
    DepartureTime TIME NOT NULL,
    ArrivalTime TIME NOT NULL,
    DaysOfWeek VARCHAR(100) NOT NULL,   -- e.g. 'Mon,Tue,Wed,Thu,Fri'
    StartDate DATE NOT NULL DEFAULT GETDATE(),
    EndDate DATE NULL,                 -- null = ongoing
    IsActive BIT NOT NULL DEFAULT 1,
    FOREIGN KEY (FerryID) REFERENCES Ferry(FerryID),
    FOREIGN KEY (RouteID) REFERENCES Route(RouteID)
);








//My ferries table

CREATE OR ALTER VIEW vw_FerryDisplay AS
SELECT 
    f.FerryID,
    f.FerryCode,
    f.FerryName,
    f.TotalCapacity AS Capacity,
    f.Status,
    f.OwnerID,

    -- SEAT INFO PER FLOOR (without Price)
    STUFF((
        SELECT CHAR(10) + 'Floor ' + CAST(ff.FloorNumber AS VARCHAR(5)) + 
               ' ' + CAST(ff.Rows AS VARCHAR(5)) + 'x' + CAST(ff.Columns AS VARCHAR(5))
        FROM FerryFloor ff
        WHERE ff.FerryID = f.FerryID
        ORDER BY ff.FloorNumber
        FOR XML PATH(''), TYPE
    ).value('.', 'NVARCHAR(MAX)'), 1, 1, '') AS Seats,

    -- ROUTE ASSIGNED FROM FerryRoute TABLE
    ISNULL((
        SELECT TOP 1 
            r.Origin + ' <--> ' + r.Destination
        FROM FerryRoute fr
        INNER JOIN Route r ON r.RouteID = fr.RouteID
        WHERE fr.FerryID = f.FerryID
        ORDER BY fr.FerryRouteID ASC
    ), 'No trips / No route') AS Route

FROM Ferry f;


        
     

     //Search Ferry view

CREATE OR ALTER VIEW vw_FerrySearch AS
SELECT
    t.TripID,
    f.FerryID,
    u.CompanyName AS Company,
    f.FerryName AS Ferry,
    CONCAT(r.Origin, ' -> ', r.Destination) AS Route,
    CAST(t.TripDate AS date) AS TripDate, 
    t.DepartureTime,
    t.ArrivalTime,
    f.Status AS FerryStatus,

    -- Total seats = SUM of all floor capacities
    (SELECT SUM(capacity)
     FROM FerryFloor ff
     WHERE ff.FerryID = f.FerryID) AS TotalSeats,

    -- Booked seats for this specific trip
    (SELECT COUNT(*)
     FROM BookedSeats bs
     WHERE bs.TripID = t.TripID) AS BookedSeats,

    -- Available seats
    (
        (SELECT SUM(capacity)
         FROM FerryFloor ff
         WHERE ff.FerryID = f.FerryID)
        -
        (SELECT COUNT(*)
         FROM BookedSeats bs
         WHERE bs.TripID = t.TripID)
    ) AS AvailableSeats

FROM Trip t
JOIN Ferry f ON t.FerryID = f.FerryID
JOIN Users u ON f.OwnerID = u.UserID
JOIN Route r ON t.RouteID = r.RouteID;


  